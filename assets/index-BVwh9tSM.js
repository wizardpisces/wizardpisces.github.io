import{_ as T,r as p,o as i,c as u,F as P,d as A,n as S,a as l,t as f,e as ae,f as m,g as Z,h as Q,i as re,j as g,k as ee,l as le,w as ce,m as q,v as J,p as Y,b as ie,q as ue,s as de,x as he,y as te}from"./index-nbwtefyW.js";const ge={name:"TreeFolderSubHeaders",props:{headers:{type:Array}},setup(t){let{activeSubHeader:o,setActiveSubHeader:a}=Z();function e(s){a(s)}return{onSubHeaderClick:e,activeSubHeader:o}}},me={class:"tree-folder-sub-headers"},_e=["href","onClick"];function fe(t,o,a,e,s,r){const n=p("tree-folder-sub-headers",!0);return i(),u("ul",me,[(i(!0),u(P,null,A(a.headers,(c,d)=>(i(),u("li",{key:d,class:S({"tree-folder-sub-header":!0,active:e.activeSubHeader.title===c.title})},[l("a",{href:c.link,class:"sidebar-link",onClick:_=>e.onSubHeaderClick(c)},f(c.title),9,_e),c.children?(i(),ae(n,{key:0,headers:c.children},null,8,["headers"])):m("",!0)],2))),128))])}const ve=T(ge,[["render",fe]]),ye={name:"RightToc",components:{TreeFolderSubHeaders:ve},props:{headers:{type:Array,default:()=>[]}}},ke={key:0,class:"right-toc"},we=l("div",{class:"toc-header"},"目录",-1),pe={class:"toc-content"};function Se(t,o,a,e,s,r){const n=p("tree-folder-sub-headers");return a.headers&&a.headers.length?(i(),u("aside",ke,[we,l("div",pe,[Q(n,{headers:a.headers},null,8,["headers"])])])):m("",!0)}const be=T(ye,[["render",Se]]);let F=null,M=null,z=null;async function K(){if(F)return F;try{const t=await fetch("/blog-embeddings-bge.json");if(!t.ok)throw new Error(`Failed to load embeddings: ${t.status}`);return F=await t.json(),console.log(`✅ 已加载 ${F.length} 个段落嵌入向量`),F}catch(t){throw console.error("❌ 加载嵌入向量失败:",t),t}}async function j(){if(M)return M;try{const t=await fetch("/blog-chunks.json");if(!t.ok)throw new Error(`Failed to load chunks: ${t.status}`);return M=await t.json(),console.log(`✅ 已加载 ${M.length} 个文档段落`),M}catch(t){throw console.error("❌ 加载分段数据失败:",t),t}}async function D(){if(z)return z;try{console.log("🤖 正在加载 BGE 中文嵌入模型...");const{pipeline:t}=await re(async()=>{const{pipeline:o}=await import("./transformers.web-Ng3if5QZ.js");return{pipeline:o}},[]);return z=await t("feature-extraction","Xenova/bge-small-zh-v1.5",{progress_callback:o=>{o.status==="downloading"&&console.log(`📥 下载模型: ${o.name} - ${Math.round(o.progress||0)}%`)}}),console.log("✅ BGE 嵌入模型加载完成"),z}catch(t){throw console.error("❌ 加载嵌入模型失败:",t),t}}function Ce(t,o){if(!t||!o||t.length!==o.length)return 0;let a=0,e=0,s=0;for(let r=0;r<t.length;r++)a+=t[r]*o[r],e+=t[r]*t[r],s+=o[r]*o[r];return e===0||s===0?0:a/(Math.sqrt(e)*Math.sqrt(s))}async function xe(t){try{const a=await(await D())(t,{pooling:"mean",normalize:!0}),e=Array.from(a.data);return console.log(`🎯 为查询生成了 ${e.length} 维语义向量`),e}catch(o){throw console.error("❌ 生成查询嵌入向量失败:",o),o}}async function Fe(t,o=15){console.log(`🔍 分段搜索: "${t}"`);const a=await xe(t),e=await K(),s=await j(),r=[];for(const n of e){const c=Ce(a,n.embedding);if(c>.1){const d=s.find(_=>_.chunkId===n.chunkId);if(d){const _=d.content.toLowerCase(),w=t.toLowerCase(),R=_.includes(w);r.push({chunkId:d.chunkId,url:d.url,title:d.title,originalTitle:d.originalTitle,content:d.content,chunkIndex:d.chunkIndex,totalChunks:d.totalChunks,similarity:c,containsQuery:R,startPos:d.startPos,endPos:d.endPos})}}}return r.sort((n,c)=>c.similarity-n.similarity),console.log(`📄 找到 ${r.length} 个相关段落`),r.slice(0,o)}function Me(t,o=5){const a=new Map;for(const s of t){a.has(s.url)||a.set(s.url,{url:s.url,title:s.originalTitle,chunks:[],maxSimilarity:0,avgSimilarity:0,containsQuery:!1,totalChunks:s.totalChunks});const r=a.get(s.url);r.chunks.push(s),r.maxSimilarity=Math.max(r.maxSimilarity,s.similarity),r.containsQuery=r.containsQuery||s.containsQuery}const e=Array.from(a.values()).map(s=>{s.avgSimilarity=s.chunks.reduce((d,_)=>d+_.similarity,0)/s.chunks.length;const r=s.chunks[0];let n=r.content;n.length>350&&(n=n.substring(0,350)+"...");const c=s.maxSimilarity*.7+s.avgSimilarity*.3;return{title:s.title,url:s.url,snippet:n,score:c,containsQuery:s.containsQuery,semanticScore:s.maxSimilarity,avgSimilarity:s.avgSimilarity,matchedChunks:s.chunks.length,totalChunks:s.totalChunks,bestChunk:{index:r.chunkIndex,similarity:r.similarity,content:r.content}}});return e.sort((s,r)=>{if(Math.abs(s.score-r.score)<.03){if(s.containsQuery&&!r.containsQuery)return-1;if(!s.containsQuery&&r.containsQuery)return 1}return r.score-s.score}),e.slice(0,o)}async function Qe(t,o=5){if(!t||typeof t!="string")return[];try{console.log(`🚀 开始分段语义搜索: "${t}"`);const a=await Fe(t,o*3);if(a.length===0)return console.log("⚠️ 未找到相关段落"),[];const e=Me(a,o);return console.log(`✅ 分段语义搜索完成，返回 ${e.length} 个结果`),e.length>0&&(console.log("🎯 分段搜索结果排序:"),e.forEach((s,r)=>{console.log(`  ${r+1}. ${s.title}`),console.log(`     - 综合分数: ${(s.score*100).toFixed(1)}%`),console.log(`     - 最高相似度: ${(s.semanticScore*100).toFixed(1)}%`),console.log(`     - 匹配段落: ${s.matchedChunks}/${s.totalChunks}`),console.log(`     - 包含关键词: ${s.containsQuery?"是":"否"}`)})),e}catch(a){return console.error("❌ 分段语义搜索失败:",a),[]}}async function Te(){try{await K(),await j();const t=D(),o=new Promise(a=>setTimeout(()=>a(!0),2e3));return await Promise.race([t,o]),!0}catch(t){return console.error("❌ 语义搜索不可用:",t),!1}}async function Ee(){try{return console.log("🔥 开始预热分段语义搜索..."),await K(),await j(),await D(),console.log("✅ 分段语义搜索预热完成"),!0}catch(t){return console.error("❌ 分段语义搜索预热失败:",t),!1}}const Ie={name:"BlogSearch",setup(){const t=g(""),o=g([]),a=g("semantic"),e=g(!1),s=g(!1),r=g(!0),n=g(!1),c=g(""),d=g(!1),_=g(""),w=g(!1),R=g(null),B=g(null),oe=ee(()=>o.value.length>0||s.value),H=async(h,y=10)=>{try{const se=await(await fetch("/blog-content.json")).json(),b=h.toLowerCase(),$=[];for(const C of se){const I=C.title||"",k=C.content||"",G=I.toLowerCase(),L=k.toLowerCase();if(G.includes(b)||L.includes(b)){let x=k.length>200?k.substring(0,200)+"...":k;if(L.includes(b)){const O=L.indexOf(b),W=Math.max(0,O-100),X=Math.min(k.length,O+h.length+100);x=k.substring(W,X).trim(),W>0&&(x="..."+x),X<k.length&&(x+="...")}$.push({title:I,url:C.url,snippet:x,containsQuery:!0,score:G.includes(b)?.9:.7})}}return $.sort((C,I)=>I.score-C.score).slice(0,y)}catch(E){return console.error("❌ 关键词搜索失败:",E),[]}};le(async()=>{try{const h=await Te();if(n.value=h,h){console.log("✅ 语义搜索可用"),d.value=!0,_.value="正在加载分段语义搜索模型...";try{await Ee(),_.value="分段语义搜索已准备就绪！",console.log("🔥 语义搜索预热完成"),setTimeout(()=>{d.value=!1,_.value=""},1500)}catch(y){console.warn("⚠️ 语义搜索预热失败，但仍可使用:",y),d.value=!1,_.value=""}}else console.log("⚠️ 语义搜索不可用，使用关键词搜索"),a.value="keyword";r.value=!1}catch(h){console.error("❌ 搜索引擎初始化失败:",h),c.value="搜索引擎初始化失败",a.value="keyword",r.value=!1}}),ce(a,h=>{h==="semantic"&&!n.value?(a.value="keyword",c.value="语义搜索不可用，已切换到关键词搜索"):c.value=""});const V=async()=>{if(t.value.trim()){e.value=!0,s.value=!0,c.value="";try{let h=[];if(a.value==="semantic"){console.log(`🧠 使用语义搜索: "${t.value}"`);try{h=await Qe(t.value,10)}catch(y){console.error("❌ 语义搜索失败，回退到关键词搜索:",y),c.value="语义搜索失败，自动切换到关键词搜索",h=await H(t.value,10)}}else console.log(`🔍 使用关键词搜索: "${t.value}"`),h=await H(t.value,10);o.value=h,console.log(`✅ 搜索完成，返回 ${h.length} 个结果`)}catch(h){console.error("❌ 搜索失败:",h),c.value="搜索失败，请重试",o.value=[]}finally{e.value=!1}}},ne=()=>{a.value="keyword",c.value="",t.value.trim()&&V()},N=()=>{w.value=!0,ue(()=>{B.value&&B.value.focus()})},U=()=>{w.value=!1,t.value="",o.value=[],s.value=!1,c.value=""};return{searchQuery:t,searchResults:o,searchMode:a,isLoading:e,hasSearched:s,isInitializing:r,semanticAvailable:n,error:c,isWarmingUp:d,warmupProgress:_,isExpanded:w,hasResults:oe,searchInput:R,expandedSearchInput:B,handleSearch:V,switchToKeywordSearch:ne,expandSearch:N,collapseSearch:U,toggleSearch:()=>{w.value?U():N()},toggleSearchMode:()=>{a.value=a.value==="semantic"?"keyword":"semantic"},highlightQuery:h=>{if(!t.value.trim())return h;const y=t.value.trim(),E=new RegExp(`(${y})`,"gi");return h.replace(E,"<mark>$1</mark>")}}}},v=t=>(de("data-v-49d4f8a6"),t=t(),he(),t),ze={key:0,class:"compact-search-bar"},Re=v(()=>l("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[l("circle",{cx:"11",cy:"11",r:"8"}),l("path",{d:"21 21l-4.35-4.35"})],-1)),Be=[Re],Le=["title"],Pe={key:1,class:"expanded-search"},Ae={class:"search-header"},Ke={class:"search-input-container"},je=["disabled"],De={key:0,width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},He=v(()=>l("circle",{cx:"11",cy:"11",r:"8"},null,-1)),Ve=v(()=>l("path",{d:"21 21l-4.35-4.35"},null,-1)),Ne=[He,Ve],Ue={key:1,class:"loading-spinner"},$e={class:"search-controls"},Ge={class:"search-mode-selector"},Oe=v(()=>l("div",{class:"close-icon"},[l("span",{class:"close-line close-line-1"}),l("span",{class:"close-line close-line-2"})],-1)),We=[Oe],Xe={key:0,class:"warmup-notice"},qe=v(()=>l("span",{class:"warmup-icon"},"🚀",-1)),Je=v(()=>l("div",{class:"warmup-spinner"},null,-1)),Ye={key:2,class:"search-results-container"},Ze={class:"results-header"},et=v(()=>l("div",{class:"close-icon"},[l("span",{class:"close-line close-line-1"}),l("span",{class:"close-line close-line-2"})],-1)),tt=[et],ot={class:"search-results"},nt=["href"],st={key:0,class:"match-tag"},at={key:1,class:"score-tag"},rt={key:2,class:"chunk-tag"},lt=["innerHTML"],ct={key:3,class:"no-results"},it={key:0,class:"search-tip"},ut={key:4,class:"initializing"},dt=v(()=>l("p",null,"🚀 正在初始化搜索引擎...",-1)),ht=[dt],gt={key:5,class:"error-message"};function mt(t,o,a,e,s,r){return i(),u("div",{class:S(["blog-search",{expanded:e.isExpanded||e.hasResults}])},[!e.isExpanded&&!e.hasResults?(i(),u("div",ze,[l("div",{class:"search-icon",onClick:o[0]||(o[0]=(...n)=>e.toggleSearch&&e.toggleSearch(...n))},Be),q(l("input",{"onUpdate:modelValue":o[1]||(o[1]=n=>e.searchQuery=n),type:"text",placeholder:"搜索博客...",onKeyup:o[2]||(o[2]=Y((...n)=>e.handleSearch&&e.handleSearch(...n),["enter"])),onFocus:o[3]||(o[3]=(...n)=>e.expandSearch&&e.expandSearch(...n)),class:"compact-search-input",ref:"searchInput"},null,544),[[J,e.searchQuery]]),l("div",{class:"search-mode-toggle",onClick:o[4]||(o[4]=(...n)=>e.toggleSearchMode&&e.toggleSearchMode(...n)),title:e.searchMode==="semantic"?"语义搜索":"关键词搜索"},f(e.searchMode==="semantic"?"🧠":"🔍"),9,Le)])):m("",!0),e.isExpanded||e.hasResults?(i(),u("div",Pe,[l("div",Ae,[l("div",Ke,[q(l("input",{"onUpdate:modelValue":o[5]||(o[5]=n=>e.searchQuery=n),type:"text",placeholder:"搜索博客内容...",onKeyup:o[6]||(o[6]=Y((...n)=>e.handleSearch&&e.handleSearch(...n),["enter"])),class:"search-input",ref:"expandedSearchInput"},null,544),[[J,e.searchQuery]]),l("button",{onClick:o[7]||(o[7]=(...n)=>e.handleSearch&&e.handleSearch(...n)),class:"search-button",disabled:e.isLoading},[e.isLoading?(i(),u("div",Ue)):(i(),u("svg",De,Ne))],8,je)]),l("div",$e,[l("div",Ge,[l("button",{onClick:o[8]||(o[8]=n=>e.searchMode="semantic"),class:S(["mode-btn",{active:e.searchMode==="semantic"}]),title:"语义搜索 - 基于BGE中文模型的向量相似度"}," 🧠 语义 ",2),l("button",{onClick:o[9]||(o[9]=n=>e.searchMode="keyword"),class:S(["mode-btn",{active:e.searchMode==="keyword"}]),title:"关键词搜索 - 基于关键词匹配"}," 🔍 关键词 ",2)]),l("button",{onClick:o[10]||(o[10]=(...n)=>e.collapseSearch&&e.collapseSearch(...n)),class:"collapse-btn",title:"关闭搜索"},We)])]),e.isWarmingUp?(i(),u("div",Xe,[qe,l("span",null,f(e.warmupProgress),1),Je])):m("",!0)])):m("",!0),e.searchResults.length>0?(i(),u("div",Ye,[l("div",Ze,[l("h3",null,"搜索结果 ("+f(e.searchResults.length)+")",1),l("button",{onClick:o[11]||(o[11]=(...n)=>e.collapseSearch&&e.collapseSearch(...n)),class:"close-results-btn",title:"关闭搜索结果"},tt)]),l("div",ot,[(i(!0),u(P,null,A(e.searchResults,n=>(i(),u("div",{key:n.url,class:"search-result-item"},[l("h4",null,[l("a",{href:n.url},f(n.title),9,nt),n.containsQuery?(i(),u("span",st,"包含匹配词")):m("",!0),e.searchMode==="semantic"&&n.score?(i(),u("span",at," 相似度: "+f((n.score*100).toFixed(1))+"% ",1)):m("",!0),e.searchMode==="semantic"&&n.matchedChunks?(i(),u("span",rt,f(n.matchedChunks)+"/"+f(n.totalChunks)+" 段落匹配 ",1)):m("",!0)]),n.snippet?(i(),u("p",{key:0,class:"result-content",innerHTML:e.highlightQuery(n.snippet)},null,8,lt)):m("",!0)]))),128))])])):e.hasSearched&&!e.isLoading?(i(),u("div",ct,[l("p",null,'未找到与 "'+f(e.searchQuery)+'" 相关的内容',1),e.searchMode==="semantic"?(i(),u("p",it,[ie(" 尝试使用不同的关键词或切换到关键词搜索 "),l("button",{onClick:o[12]||(o[12]=(...n)=>e.switchToKeywordSearch&&e.switchToKeywordSearch(...n)),class:"switch-mode-btn"},"切换到关键词搜索")])):m("",!0)])):m("",!0),e.isInitializing?(i(),u("div",ut,ht)):m("",!0),e.error?(i(),u("div",gt,[l("p",null,"❌ "+f(e.error),1),l("button",{onClick:o[13]||(o[13]=(...n)=>e.switchToKeywordSearch&&e.switchToKeywordSearch(...n)),class:"switch-mode-btn"},"切换到关键词搜索")])):m("",!0)],2)}const _t=T(Ie,[["render",mt],["__scopeId","data-v-49d4f8a6"]]),ft={name:"BlogToolbar",components:{BlogSearch:_t},props:{showFontControl:{type:Boolean,default:!0}},emits:["font-size-change"],setup(t,{emit:o}){const a=g("medium"),e=[{value:"small",label:"小",icon:"A",iconClass:"small-icon"},{value:"medium",label:"中",icon:"A",iconClass:"medium-icon"},{value:"large",label:"大",icon:"A",iconClass:"large-icon"},{value:"xlarge",label:"超大",icon:"A",iconClass:"xlarge-icon"}],s=n=>{a.value=n,localStorage.setItem("blog-font-size",n),o("font-size-change",n)},r=localStorage.getItem("blog-font-size");return r&&e.find(n=>n.value===r)&&(a.value=r),te("currentFontSize",a),{currentFontSize:a,fontSizes:e,setFontSize:s}}},vt={class:"blog-toolbar"},yt={class:"toolbar-content"},kt={class:"search-section"},wt={key:0,class:"font-control"},pt={class:"font-size-buttons"},St=["onClick","title"];function bt(t,o,a,e,s,r){const n=p("blog-search");return i(),u("div",vt,[l("div",yt,[l("div",kt,[Q(n)]),a.showFontControl?(i(),u("div",wt,[l("div",pt,[(i(!0),u(P,null,A(e.fontSizes,c=>(i(),u("button",{key:c.value,onClick:d=>e.setFontSize(c.value),class:S(["font-btn",{active:e.currentFontSize===c.value}]),title:`字体大小: ${c.label}`},[l("span",{class:S(c.iconClass)},f(c.icon),3)],10,St))),128))])])):m("",!0)])])}const Ct=T(ft,[["render",bt],["__scopeId","data-v-001c9713"]]),xt={name:"Blog",components:{RightToc:be,BlogToolbar:Ct},setup(){const{activeBlog:t}=Z(),o=ee(()=>t.value.subHeaders||[]),a=g("medium"),e=localStorage.getItem("blog-font-size");e&&(a.value=e);const s=r=>{a.value=r};return te("currentFontSize",a),{activeSubHeaders:o,handleFontSizeChange:s}}},Ft={class:"blog-container"},Mt={class:"blog-content"};function Qt(t,o,a,e,s,r){const n=p("blog-toolbar"),c=p("router-view"),d=p("right-toc");return i(),u("div",Ft,[Q(n,{onFontSizeChange:e.handleFontSizeChange},null,8,["onFontSizeChange"]),l("div",Mt,[Q(c)]),Q(d,{headers:e.activeSubHeaders},null,8,["headers"])])}const Rt=T(xt,[["render",Qt]]);export{Rt as default};
